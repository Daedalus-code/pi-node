#!/bin/bash

# By Rainman
# V20212512
# 0.3.9.7

source /home/pi/pitrump.conf
source /usr/local/bin/include/color

# node_stats directory
mkdir /tmp/node_stats &>/dev/null

### install needed packages ####################################################

# rrdtool setup (graphs, round robin database)
if ! [ -x "$(command -v rrdtool)" ]; then
  sudo mkdir /var/lib/rrd &>/dev/null
  sudo mkdir /var/www/html/rrdtool &>/dev/null
  sudo chown -R "$(whoami)":"$(whoami)" /var/lib/rrd
  sudo apt-get install librrds-perl rrdtool -y 2>&1
else
  printf '%b' "[${G1:?}OK${N0:?}] RRDTool\n"
fi

# apache2 setup (webserver, php)
if ! [ -x "$(command -v apache2)" ]; then
  sudo apt-get install apache2 php libapache2-mod-php -y 2>&1
  sudo chown -R "$(whoami)":"$(whoami)" /var/www/html
  printf '%b' "[${G1:?}OK${N0:?}] Restarting Apache\n"
  sudo systemctl restart apache2 2>&1
  LOCAL=$(ifconfig 2>&1 | grep "inet" 2>&1 | head -1 2>&1 |
    sed -En 's/127.0.0.1//;s/.*inet (addr:)?(([0-9]*\.){3}[0-9]*).*/\2/p' 2>&1)
  echo "[!!] Try your $LOCAL IP Address"
  echo
  read -r -p "Press Enter to continue" </dev/tty
  echo
else
  printf '%b' "[${G1:?}OK${N0:?}] Webserver\n"
fi

### create round robin databases for system (rrdtool) ##########################

# load 1
if [ ! -f "/tmp/node_stats/load.rrd" ]; then
  rrdtool create /tmp/node_stats/load.rrd \
    --step=60 \
    DS:load:GAUGE:300:U:U \
    RRA:AVERAGE:0.5:1:86400 \
    RRA:AVERAGE:0.5:1440:400
fi
# load 5
if [ ! -f "/tmp/node_stats/load5.rrd" ]; then
  rrdtool create /tmp/node_stats/load5.rrd \
    --step=60 \
    DS:load5:GAUGE:300:U:U \
    RRA:AVERAGE:0.5:1:86400 \
    RRA:AVERAGE:0.5:1440:400
fi
# load 15
if [ ! -f "/tmp/node_stats/load15.rrd" ]; then
  rrdtool create /tmp/node_stats/load15.rrd \
    --step=60 \
    DS:load15:GAUGE:300:U:U \
    RRA:AVERAGE:0.5:1:86400 \
    RRA:AVERAGE:0.5:1440:400
fi
# temp
if [ ! -f "/tmp/node_stats/temp.rrd" ]; then
  rrdtool create /tmp/node_stats/temp.rrd \
    --step=60 \
    DS:temp:GAUGE:300:U:U \
    RRA:AVERAGE:0.5:1:86400 \
    RRA:AVERAGE:0.5:1440:400
fi
# memory available
if [ ! -f "/tmp/node_stats/memory_total.rrd" ]; then
  rrdtool create /tmp/node_stats/memory_total.rrd \
    --step=60 \
    DS:memory_total:GAUGE:300:U:U \
    RRA:AVERAGE:0.5:1:86400 \
    RRA:AVERAGE:0.5:1440:400
fi
# memory free
if [ ! -f "/tmp/node_stats/memory_free.rrd" ]; then
  rrdtool create /tmp/node_stats/memory_free.rrd \
    --step=60 \
    DS:memory_free:GAUGE:300:U:U \
    RRA:AVERAGE:0.5:1:86400 \
    RRA:AVERAGE:0.5:1440:400
fi
# hdd
if [ ! -f "/tmp/node_stats/hdd.rrd" ]; then
  rrdtool create /tmp/node_stats/hdd.rrd \
    --step=60 \
    DS:hdd:GAUGE:300:U:U \
    RRA:AVERAGE:0.5:1:86400 \
    RRA:AVERAGE:0.5:1440:400
fi
# download
if [ ! -f "/tmp/node_stats/net_received.rrd" ]; then
  rrdtool create /tmp/node_stats/net_received.rrd \
    --step=60 \
    DS:net_received:GAUGE:300:U:U \
    RRA:AVERAGE:0.5:1:86400 \
    RRA:AVERAGE:0.5:1440:400
fi
# upload
if [ ! -f "/tmp/node_stats/net_send.rrd" ]; then
  rrdtool create /tmp/node_stats/net_send.rrd \
    --step=60 \
    DS:net_send:GAUGE:300:U:U \
    RRA:AVERAGE:0.5:1:86400 \
    RRA:AVERAGE:0.5:1440:400
fi

### create round robin databases for wallet (rrdtool) ##########################

# balance
if [ ! -f "/tmp/node_stats/balance.rrd" ]; then
  rrdtool create /tmp/node_stats/balance.rrd \
    --step=60 \
    DS:balance:GAUGE:300:U:U \
    RRA:AVERAGE:0.5:1:86400 \
    RRA:AVERAGE:0.5:1440:400
fi
# stakes
if [ ! -f "/tmp/node_stats/stakes.rrd" ]; then
  rrdtool create /tmp/node_stats/stakes.rrd \
    --step=60 \
    DS:stakes:GAUGE:300:U:U \
    RRA:AVERAGE:0.5:1:86400 \
    RRA:AVERAGE:0.5:1440:400
fi
# inputs
if [ ! -f "/tmp/node_stats/inputs.rrd" ]; then
  rrdtool create /tmp/node_stats/inputs.rrd \
    --step=60 \
    DS:inputs:GAUGE:300:U:U \
    RRA:AVERAGE:0.5:1:86400 \
    RRA:AVERAGE:0.5:1440:400
fi
# mempool
if [ ! -f "/tmp/node_stats/mempool.rrd" ]; then
  rrdtool create /tmp/node_stats/mempool.rrd \
    --step=60 \
    DS:mempool:GAUGE:300:U:U \
    RRA:AVERAGE:0.5:1:86400 \
    RRA:AVERAGE:0.5:1440:400
fi

### update rrdtool databases ###################################################

# wallet daemon uptime function
# function for waiting with stuff before a limit (seconds) is reached
function uptime_daemon() {
  PID="$(pidof trumpcoind 2>&1)"
  HZ=$(getconf CLK_TCK 2>&1)
  UPTIME_CMD=$(awk '{print $1}' </proc/uptime)
  STARTTIME=$(awk '{print $22}' </proc/"$PID"/stat)
  echo $(("${UPTIME_CMD%.*}" - "$STARTTIME" / "$HZ"))
}

# greater than n seconds, continue
if [[ "$(uptime_daemon)" -gt "600" ]] &>/dev/null; then

  rrdtool update /tmp/node_stats/load.rrd N:"$(uptime 2>&1 | egrep -o "[0-9]+.[0-9]+, [0-9]+.[0-9]+, [0-9]+.[0-9]+" 2>&1 | tr -d ',' 2>&1 | awk '{ print $1 }')"
  rrdtool update /tmp/node_stats/load5.rrd N:"$(uptime 2>&1 | egrep -o "[0-9]+.[0-9]+, [0-9]+.[0-9]+, [0-9]+.[0-9]+" 2>&1 | tr -d ',' 2>&1 | awk '{ print $2 }')"
  rrdtool update /tmp/node_stats/load15.rrd N:"$(uptime 2>&1 | egrep -o "[0-9]+.[0-9]+, [0-9]+.[0-9]+, [0-9]+.[0-9]+" 2>&1 | tr -d ',' 2>&1 | awk '{ print $3 }')"
  rrdtool update /tmp/node_stats/temp.rrd N:"$(echo "$(</sys/class/thermal/thermal_zone0/temp) / 100 * 0.1" | bc)"
  rrdtool update /tmp/node_stats/memory_total.rrd N:"$(free --mega 2>&1 | grep "Mem" 2>&1 | awk '{ print $2 }' 2>&1)"
  rrdtool update /tmp/node_stats/memory_free.rrd N:"$(echo "$(free --mega 2>&1 | grep "Mem" 2>&1 | awk '{ print $2 }' 2>&1)-$(free --mega 2>&1 | grep "Mem" 2>&1 | awk '{ print $4 }' 2>&1)" | bc)"
  rrdtool update /tmp/node_stats/hdd.rrd N:"$(df -h 2>&1 | egrep "mmcblk0p2|mmcblk0p3|/dev/root" 2>&1 | awk '{ print $3 }' 2>&1 | tr -d 'G')"
  rrdtool update /tmp/node_stats/net_received.rrd N:"$(ifconfig 2>&1 | egrep "wla*|eth*" 2>&1 | grep "RX packets" 2>&1 | head -1 2>&1 | awk '{ print $6 $7 }' 2>&1 | tr -d '()' 2>&1 | egrep -o "[0-9]+.[0-9]+")"
  rrdtool update /tmp/node_stats/net_send.rrd N:"$(ifconfig 2>&1 | egrep "wla*|eth*" 2>&1 | grep "TX packets" 2>&1 | head -1 2>&1 | awk '{ print $6 $7 }' 2>&1 | tr -d '()' 2>&1 | egrep -o "[0-9]+.[0-9]+")"
  rrdtool update /tmp/node_stats/balance.rrd N:"$(grep "balance" /tmp/node_data/getinfo 2>&1 | egrep -o "[0-9]+.[0-9]+" 2>&1 | awk '{ printf "%.2f\n", $1 }' 2>&1)"
  rrdtool update /tmp/node_stats/stakes.rrd N:"$(cat /tmp/node_stats/staking 2>/dev/null | wc -l 2>&1)"
  rrdtool update /tmp/node_stats/inputs.rrd N:"$(grep "address" /tmp/node_data/listunspent 2>&1 | wc -l 2>&1)"
  rrdtool update /tmp/node_stats/mempool.rrd N:"$(grep "size" /tmp/node_data/getmempoolinfo 2>&1 | egrep -o "[0-9]+" 2>&1)"

fi

#### create index.php ##########################################################

cat >/var/www/html/index.php <<'EOF'
<div id="content" align="center">
<?php
  header("refresh: 60;");
?>
<?php
  // background color (dark blue)
  echo "<body style='background-color:2D3037'>";
  // graphs
  echo "<img src='load_graph.png' alt='Load' />";
  echo "<img src='temp_graph.png' alt='CPUTemp' />";
  echo "<img src='memory_graph.png' alt='Memory' />";
  echo "<img src='hdd_graph.png' alt='Drive' />";
  echo "<img src='network_graph.png' alt='Network' />";
  echo "<img src='balance_graph.png' alt='Balance' />";
  echo "<img src='stakes_graph.png' alt='Stakes' />";
  echo "<img src='inputs_graph.png' alt='Inputs' />";
  echo "<img src='mempool_graph.png' alt='Mempool' />";
EOF

#### create shell (graphs) #####################################################

cat <<<'#!/bin/bash

# loadavg 1,5,15m (24hour)
rrdtool graph /var/www/html/load_graph.png \
-w 400 -h 164 -a PNG \
--slope-mode \
--start -24hour --end now \
--vertical-label "System Load" \
--color BACK#565875 \
--color FONT#FFFFFF \
--color CANVAS#42445F \
--color GRID#565875 \
--color FRAME#565875 \
--color SHADEA#565875 \
--color SHADEB#565875 \
DEF:load=/tmp/node_stats/load.rrd:load:MAX \
DEF:load5=/tmp/node_stats/load5.rrd:load5:MAX \
DEF:load15=/tmp/node_stats/load15.rrd:load15:MAX \
GPRINT:load:LAST:%.2lf\ Now \
GPRINT:load5:AVERAGE:%.2lf\ AVG \
GPRINT:load15:AVERAGE:%.2lf\ AVG \
LINE1:load#00FF33:"Load 1m" \
LINE1:load5#FFE000:"Load 5m" \
LINE1:load15#FF5100:"Load 15m"

# inputs (24hour)
rrdtool graph /var/www/html/inputs_graph.png \
-w 400 -h 164 -a PNG \
--slope-mode \
--start -24hour --end now \
--vertical-label "Wallet Inputs" \
--alt-autoscale-max --lower-limit=1 \
--color BACK#565875 \
--color FONT#FFFFFF \
--color CANVAS#42445F \
--color GRID#565875 \
--color FRAME#565875 \
--color SHADEA#565875 \
--color SHADEB#565875 \
DEF:inputs=/tmp/node_stats/inputs.rrd:inputs:MAX \
GPRINT:inputs:LAST:%.0lf\ Now \
GPRINT:inputs:MAX:%.0lf\ Max \
GPRINT:inputs:MIN:%.0lf\ Min \
LINE1:inputs#3FFF33

# stakes (24hour)
rrdtool graph /var/www/html/stakes_graph.png \
-w 400 -h 164 -a PNG \
--slope-mode \
--start -24hour --end now \
--vertical-label "Wallet Stakes" \
--alt-autoscale-max --lower-limit=1 \
--color BACK#565875 \
--color FONT#FFFFFF \
--color CANVAS#42445F \
--color GRID#565875 \
--color FRAME#565875 \
--color SHADEA#565875 \
--color SHADEB#565875 \
DEF:stakes=/tmp/node_stats/stakes.rrd:stakes:MAX \
GPRINT:stakes:LAST:%.2lf\ Now \
GPRINT:stakes:AVERAGE:%.2lf\ AVG \
GPRINT:stakes:MAX:%.2lf\ Max \
GPRINT:stakes:MIN:%.2lf\ Min \
LINE1:stakes#9633FF

# balance (24hour)
rrdtool graph /var/www/html/balance_graph.png \
-w 400 -h 164 -a PNG \
--slope-mode \
--start -24hour --end now \
--vertical-label "Wallet Balance" \
--alt-autoscale-max --lower-limit=1 \
--color BACK#565875 \
--color FONT#FFFFFF \
--color CANVAS#42445F \
--color GRID#565875 \
--color FRAME#565875 \
--color SHADEA#565875 \
--color SHADEB#565875 \
DEF:balance=/tmp/node_stats/balance.rrd:balance:MAX \
GPRINT:balance:LAST:%.2lf\ Now \
GPRINT:balance:MAX:%.2lf\ Max \
GPRINT:balance:MIN:%.2lf\ Min \
LINE1:balance#3F79E5

# network (24hour)
rrdtool graph /var/www/html/network_graph.png \
-w 400 -h 164 -a PNG \
--slope-mode \
--start -24hour --end now \
--vertical-label "Network" \
--color BACK#565875 \
--color FONT#FFFFFF \
--color CANVAS#42445F \
--color GRID#565875 \
--color FRAME#565875 \
--color SHADEA#565875 \
--color SHADEB#565875 \
DEF:net_received=/tmp/node_stats/net_received.rrd:net_received:MAX \
DEF:net_send=/tmp/node_stats/net_send.rrd:net_send:MAX \
GPRINT:net_received:AVERAGE:%.2lf\ Download \
GPRINT:net_send:AVERAGE:%.2lf\ Upload \
LINE1:net_received#00FF00 \
LINE1:net_send#FF3A00

# hdd (24hour)
rrdtool graph /var/www/html/hdd_graph.png \
-w 400 -h 164 -a PNG \
--slope-mode \
--start -24hour --end now \
--vertical-label "System Drive" \
--alt-autoscale-max --lower-limit=1 \
--color BACK#565875 \
--color FONT#FFFFFF \
--color CANVAS#42445F \
--color GRID#565875 \
--color FRAME#565875 \
--color SHADEA#565875 \
--color SHADEB#565875 \
DEF:hdd=/tmp/node_stats/hdd.rrd:hdd:MAX \
GPRINT:hdd:LAST:%.2lf\ Now \
GPRINT:hdd:AVERAGE:%.2lf\ AVG \
GPRINT:hdd:MAX:%.2lf\ Max \
GPRINT:hdd:MIN:%.2lf\ Min \
LINE1:hdd#F17EFF

# memory (24hour)
rrdtool graph /var/www/html/memory_graph.png \
-w 400 -h 164 -a PNG \
--slope-mode \
--start -24hour --end now \
--vertical-label "Memory (MB)" \
--color BACK#565875 \
--color FONT#FFFFFF \
--color CANVAS#42445F \
--color GRID#565875 \
--color FRAME#565875 \
--color SHADEA#565875 \
--color SHADEB#565875 \
DEF:memory_total=/tmp/node_stats/memory_total.rrd:memory_total:MAX \
DEF:memory_free=/tmp/node_stats/memory_free.rrd:memory_free:MAX \
GPRINT:memory_total:MAX:%.2lf\M\ Total \
GPRINT:memory_free:LAST:%.2lf\M\ Free \
LINE1:memory_total#33CEFF:"Total" \
LINE1:memory_free#4FFF33:"Free"

# cpu temperature (24hour)
rrdtool graph /var/www/html/temp_graph.png \
-w 400 -h 164 -a PNG \
--slope-mode \
--start -24hour --end now \
--vertical-label "CPU Temp (°C)" \
--color BACK#565875 \
--color FONT#FFFFFF \
--color CANVAS#42445F \
--color GRID#565875 \
--color FRAME#565875 \
--color SHADEA#565875 \
--color SHADEB#565875 \
DEF:temp=/tmp/node_stats/temp.rrd:temp:MAX \
GPRINT:temp:LAST:%.2lf\°C\ Now \
GPRINT:temp:AVERAGE:%.2lf\°C\ AVG \
GPRINT:temp:MAX:%.2lf\°C\ Max \
GPRINT:temp:MIN:%.2lf\°C\ Min \
LINE1:temp#FF2D00:"CPUTemp"

# mempool (24hour)
rrdtool graph /var/www/html/mempool_graph.png \
-w 897 -h 164 -a PNG \
--slope-mode \
--start -24hour --end now \
--vertical-label "Wallet Mempool" \
--alt-autoscale-max --lower-limit=1 \
--color BACK#565875 \
--color FONT#FFFFFF \
--color CANVAS#42445F \
--color GRID#565875 \
--color FRAME#565875 \
--color SHADEA#565875 \
--color SHADEB#565875 \
DEF:mempool=/tmp/node_stats/mempool.rrd:mempool:MAX \
GPRINT:mempool:LAST:%.0lf\ Now \
GPRINT:mempool:AVERAGE:%.0lf\ AVG \
GPRINT:mempool:MAX:%.0lf\ Max \
GPRINT:mempool:MIN:%.0lf\ Min \
LINE1:mempool#FF0000' >/tmp/graphs

# run graphs script
bash /tmp/graphs 2>&1 && clear

# END
