#!/bin/bash

################################################################################

# colors
B0='\e[34m'   # Blue
B1='\e[94m'   # Blue light
CY='\e[36m'   # Cyan
C1='\e[96m'   # Cyan light
G0='\e[32m'   # Green
G1='\e[92m'   # Green light
GR='\e[90m'   # Grey
N0='\033[0m'  # No color
P0='\e[0;35m' # Purple
P1='\e[1;35m' # Purple light
R0='\e[31m'   # Red
R1='\e[91m'   # Red light
Y0='\e[33m'   # Yellow
Y1='\e[93m'   # Yellow light
BLD='\e[1m'   # Bold\brighter

################################################################################

clear
printf '%b' "${Y0}${BLD}
F   R   E   E   D   O   M   C   O   I   N${B1}

@${N0}@${B1}@${N0}  @${B1}@${N0}@${B1}    @${N0}@${B1}@${N0}@${B1}@${N0}@${B1}    @${N0}@${B1}@${N0}@${B1}@${N0}@${B1}@${N0}    @${B1}@${N0}@${B1}@${N0}@${B1}@${N0}@${B1}@${N0}
${B1}@${N0}@${B1}@${N0}@${B1} @${N0}@${B1}@${N0}   @${B1}@${N0}@${B1}@${N0}@${B1}@${N0}@${B1}@   ${N0}@${B1}@${N0}@${B1}@${N0}@${B1}@${N0}@${B1}@   ${N0}@${B1}@${N0}@${B1}@${N0}@${B1}@${N0}@${B1}@${N0}
${N0}@${B1}@${N0}!${B1}@${N0}!${B1}@${N0}@${B1}@   ${N0}@${B1}@${N0}!  ${B1}@${N0}@${B1}@   ${N0}@${B1}@${N0}!  ${B1}@${N0}@${B1}@   ${N0}@${B1}@${N0}!
!@!!@!@!   !@!  @!@   !@!  @!@   !@!${R1}
@!@ !!@!   @!@  !@!   @!@  !@!   @!!!:!${N0}
!@!  !!!   !@!  !!!   !@!  !!!   !!!!!:${R1}
!!:  !!!   !!:  !!!   !!:  !!!   !!:${N0}
:!:  !:!   :!:  !:!   :!:  !:!   :!:${R1}
::   ::    :::: ::    :::: ::    :: ::::${N0}
::    :     : :  :    :: :  :    : :: ::${R1}
${N0}
Spin up a Freedom node! ${GR}Version 1${N0}
\n"

################################################################################

reset_install() {
  # if missing
  if [[ ! -d /etc/pi-node/include ]] &>/dev/null; then
    # create install directory
    printf '%b' "[${G1}OK${N0}] mkdir   : Creating install directory as root!\n"
    sudo mkdir /etc/pi-node &>/dev/null
    printf '%b' "[${G1}OK${N0}] chown   : Updating ownership as $(whoami)!\n"
    sudo chown "$(whoami)":"$(whoami)" /etc/pi-node
    printf '%b' "[${G1}OK${N0}] cp      : Installing pi-node dashbord!\n"
    cd || exit && cp pi-node/dash /etc/pi-node
    printf '%b' "[${G1}OK${N0}] cp -rfv : Installing directories as $(whoami)!\n"
    cd || exit && cp -rfv pi-node/include /etc/pi-node | column -t
    # create new configuration
    printf '%b' "[${G1}OK${N0}] echo    : Creating new configuration!\n"
    echo "# pi-node Configuration #
  " >/etc/pi-node/config
  fi
}

################################################################################

# if found
if [[ -f /etc/pi-node/config ]] &>/dev/null; then
  # new configuration
  printf '%b' "[${N0}!!${N0}] Config  : Config found!, reset configuration? y/n "
  read -r -p "" -n 1 -r -s
  echo
  # if yes/no
  if [[ $REPLY =~ ^[Yy]$ ]] &>/dev/null; then
    printf '%b' "[${N0}!!${N0}] Reset   : Deleting old files and directories!\n"
    rm -r /etc/pi-node &>/dev/null
    reset_install
  fi
fi

reset_install

################################################################################

printf '%b' "[${N0}!!${N0}] Check   : Install..\n" && sleep 1
printf '%b' "[${N0}!!${N0}] Github  : Updating pi-node repository!\n"
printf '%b' "[${G1}OK${N0}] Github  : $(cd || exit && cd pi-node && git pull)\n"

################################################################################

VER_FOUND="$(uname -v)"
REL_FOUND="$(uname -r)"
MOD_FOUND="$(grep "Model" /proc/cpuinfo | awk -F: '{ print $2 }' | xargs)"

################################################################################

CPU_FOUND="$(grep "model name" /proc/cpuinfo | head -1 | awk -F: '{ print $2 }' | xargs)"

# if zero
if [[ -z "$CPU_FOUND" ]] &>/dev/null; then
  CPU_FOUND="$(lscpu | grep "Model name" | awk -F: '{ print $2 }' | xargs)"
fi

################################################################################

COR_FOUND="$(egrep -c "bogomips|BogoMIPS" /proc/cpuinfo)"
MEM_FOUND="$(echo "$(echo "$(grep "MemTotal" /proc/meminfo | awk '{ print $2 }')+"$(grep "SwapTotal" /proc/meminfo | awk '{ print $2 }') | bc -l 2>/dev/null)/1024" | bc 2>/dev/null) MB"
HDD_FOUND="$(df -h --total | tail -1 | xargs | tr -d '-')"
HDD_TOTAL="$(echo "$HDD_FOUND" | awk '{ print $2 }')"
HDD_FREE="$(echo "$HDD_FOUND" | awk '{ print $4 }')"

################################################################################
# kernal release version
################################################################################

# if found
if [[ -n "$VER_FOUND" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Version : $VER_FOUND\n"
else
  printf '%b' "[${GR}!!${N0}] System  : Error\n" && exit
fi

# if found
if [[ -n "$REL_FOUND" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Release : $REL_FOUND\n"
else
  printf '%b' "[${GR}!!${N0}] System  : Error\n" && exit
fi

################################################################################
# model
################################################################################

# if found
if [[ -n "$MOD_FOUND" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Model   : $MOD_FOUND\n"
else
  printf '%b' "[${GR}!!${N0}] Model   : ${GR}Not found${N0}\n"
fi

################################################################################
# cpu
################################################################################

# if found
if [[ -n "$CPU_FOUND" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] CPU     : $CPU_FOUND $COR_FOUND Core(s)\n"
else
  printf '%b' "[${GR}!!${N0}] CPU     : Error\n" && exit
fi

################################################################################
# memory
################################################################################

# if found
if [[ -n "$MEM_FOUND" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Memory  : $MEM_FOUND\n"
  # if not enough memory
  if [[ "$(echo "$MEM_FOUND" | awk '{ print $1 }')" -lt "2000" ]] &>/dev/null; then
    printf '%b' "[${GR}!!${N0}] Memory  : Not enough memory!\n" && sleep 1
    printf '%b' "[${G1}OK${N0}] mkswap  : Creating 2G Swap..\n"
    # create 2G swap ###########################################################
    sudo fallocate -l 2G /swapfile
    sudo chmod 600 /swapfile
    sudo mkswap /swapfile
    sudo swapon /swapfile
    ############################################################################
    # if swapfile is not already in /etc/fstab, append it
    if ! grep -q "^/swapfile swap swap defaults 0 0" /etc/fstab; then
      printf '%b' "[${G1}OK${N0}] echo    : Updating fstab..\n"
      echo "/swapfile swap swap defaults 0 0" | sudo tee -a /etc/fstab >/dev/null
    fi
    # backup fstab before modification
    sudo cp /etc/fstab /etc/fstab.bak
    # format `/etc/fstab` properly using `column -t`
    sudo column -t /etc/fstab | sudo tee /etc/fstab >/dev/null
    # output data
    printf '%b' "[${G1}OK${N0}] fstab   : Output data

  $(cat /etc/fstab 2>/dev/null | column -t)
  \n"
  fi
else
  printf '%b' "[${GR}!!${N0}] Memory  : Error\n" && exit
fi

################################################################################
# hard drive
################################################################################

# if found
if [[ -n "$HDD_FOUND" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Drive   : Total $HDD_TOTAL Free $HDD_FREE\n"
  # if not enough space
  if [[ "$(echo "$HDD_FREE" | egrep "[0-9]+")" -lt "8" ]] &>/dev/null; then
    printf '%b' "[${GR}!!${N0}] Drive   : Not enough space..\n" && exit
  fi
else
  printf '%b' "[${GR}!!${N0}] Drive   : Error\n" && exit
fi

################################################################################
# wallet files
################################################################################

bash /etc/pi-node/include/find

################################################################################
# missing wallet daemon or client
################################################################################

# if no daemon found, if no client found
if [[ "$DAE_FOUND_CTRL" -eq "0" || "$CLI_FOUND_CTRL" -eq "0" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Dae/Cli : Not Found ${CY}$DAE_FOUND${N0}!\n"
  # linux
  LATEST_RELEASE="$(curl -s https://api.github.com/repos/FreedomCoin-Project/FreedomCoin-Core/releases/latest | grep '"tag_name"' | cut -d '"' -f 4)"
  printf '%b' "[${G1}OK${N0}] curl    : Checking latest release!\n"
  # change directory
  cd || exit && wget -c https://github.com/FreedomCoin-Project/FreedomCoin-Core/releases/download/"$LATEST_RELEASE"/FreedomCoin-Core-Linux.zip
  printf '%b' "[${G1}OK${N0}] wget    : Download complete!\n"
  # if missing
  if [[ ! -d FreedomCoin-Core-Linux ]]; then
    # unzip file
    unzip FreedomCoin-Core-Linux.zip
    printf '%b' "[${G1}OK${N0}] unzip   : Unzip complete!\n"
  fi
  # change directory
  cd FreedomCoin-Core-Linux || exit
  # if found
  if [[ -f freedomcoin-cli ]] &>/dev/null; then
    # install
    sudo mv freedomcoin-cli /usr/local/bin
    printf '%b' "[${G1}OK${N0}] mv      : freedomcoin-cli installed!\n"
  fi
  # if found
  if [[ -f freedomcoind ]] &>/dev/null; then
    # install
    sudo mv freedomcoind /usr/local/bin
    printf '%b' "[${G1}OK${N0}] mv      : freedomcoind installed!\n"
  fi
  # fix ownership
  sudo chown "$(whoami)":"$(whoami)" /usr/local/bin/freedomcoin*
  printf '%b' "[${G1}OK${N0}] chown   : Fixing ownership!\n"
else
  printf '%b' "[${G1}OK${N0}] Dae/Cli : FreedomCoin Daemon and Client installed!\n"
fi

################################################################################
# bootstrap
################################################################################

# less than n in free space
if [[ "$(echo "$HDD_FREE" | tr -d 'G')" -gt "6" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Blocks  : Downloading bootstrap.zip!\n"

  # if zero
  if [[ -z "$BOOTSTRAP_URL" ]] &>/dev/null; then
    BOOTSTRAP_URL="https://freedomcoin.global/wallets/bootstrap.zip"
  fi

  # bootstrap file
  OUTPUT_FILE="$(echo "$BOOTSTRAP_URL" | awk -F/ '{ print $NF }')"
  cd || exit
  # start the download and process progress
  wget -c --progress=dot:mega "$BOOTSTRAP_URL" 2>&1 |
    # capture the progress line with percentage, speed, and eta
    grep --line-buffered "[0-9]% " |
    while read -r LINE; do
      # extract the percentage, speed, size and eta using regex
      PERCENT=$(echo "$LINE" | awk -F% '{ print $1 }' | awk '{ print $NF }"%"')
      SPEED=$(echo "$LINE" | awk -F% '{ print $2 }' | awk '{ print $1 }')
      SIZE=$(echo "$LINE" | awk '{ print $1 }')
      ETA=$(echo "$LINE" | awk -F% '{ print $2 }' | awk '{ print $2 }')
      # output progress to dialog (display the progress bar)
      echo "$PERCENT" | dialog --title "Downloading $OUTPUT_FILE..." --gauge "\nURL....: $BOOTSTRAP_URL\nSpeed..: $SPEED/sec\nSize...: ${SIZE}\nETA....: $ETA" 11 65
      sleep 1
    done
  RESULT=$?
  # if any result
  if [ ! $RESULT -eq "0" ] &>/dev/null; then
    echo "[!!] Download failed"
    sleep 1
  fi

  # kill wallet
  kill -9 "$(pidof "${WALLET_DAEMON:?}" 2>/dev/null)" &>/dev/null
  printf '%b' "[${G1}OK${N0}] Blocks  : Extracting bootstrap.zip..\n"

  # unzip bootstrap.zip
  unzip /home/"$(whoami)"/bootstrap.zip -d "${DATA_DIR:?}"
  printf '%b' "[${G1}OK${N0}] Blocks  : Removing bootstrap.zip..\n"
  rm /home/"$(whoami)"/bootstrap.zip &>/dev/null
  sleep 1
else
  printf '%b' "[${G1}OK${N0}] Blocks  : Not enouh space for bootstrap.zip!\n"
fi

################################################################################
# wallet configuration
################################################################################

DATA_DIR="$(grep "DATA_DIR=" /usr/local/bin/include/pinode/pinode.conf | awk -F= '{ print $2 }' | awk '{ print $1 }' | tr -d '"')"
if [[ -n "$DATA_DIR" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Pi-Node : Old data directory found!\n"
else
  # run default
  DATA_DIR="."
fi

WALLET_LOG_DIR="$(grep "WALLET_LOG_DIR=" /usr/local/bin/include/pinode/pinode.conf | awk -F= '{ print $2 }' | awk '{ print $1 }' | tr -d '"')"
if [[ -n "$WALLET_LOG_DIR" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Pi-Node : Old log directory found!\n"
else
  # run default
  WALLET_LOG_DIR="."
fi

WALLET_CONFIG="$(grep "WALLET_CONFIG=" /usr/local/bin/include/pinode/pinode.conf | awk -F= '{ print $2 }' | awk '{ print $1 }' | tr -d '"')"
if [[ -n "$WALLET_CONFIG" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Pi-Node : Old wallet config found!\n"
else
  # run default
  WALLET_CONFIG="."
fi

PROXY="$(grep "PROXY=" /usr/local/bin/include/pinode/pinode.conf | awk -F= '{ print $2 }' | awk '{ print $1 }' | tr -d '"')"
if [[ -n "$PROXY" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Pi-Node : Old proxy setup found!\n"
  # check for tor install
  if ! [ -x "$(command -v git)" ]; then
    printf '%b' "[${G1}OK${N0}] Proxy   : Installing tor!\n"
    sudo apt-get install tor -y
    # if missing
    if [[ "$(grep -c "FreedomCoin-service" /etc/tor/torrc)" -eq "0" ]] &>/dev/null; then
      # update tor configuration
      printf '%b' "[${G1}OK${N0}] Proxy   : Updating configuration!\n"
      echo "HiddenServiceDir /var/lib/tor/FreedomCoin-service/
HiddenServicePort 15110 127.0.0.1:15110" | sudo tee -a /etc/tor/torrc >/dev/null
      # update tor configuration
      printf '%b' "[${G1}OK${N0}] Proxy   : Restarting tor!\n"
      sudo service tor@default restart
    fi
  fi
fi

################################################################################
# start wallet daemon
################################################################################

# daemon running
if [[ "$DAE_PID" -gt "0" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Daemon  : Already running! PID: $DAE_PID\n"
else
  printf '%b' "[${G1}OK${N0}] Daemon  : Starting daemon..\n"
  # start daemon
  /usr/local/bin/freedomcoind -datadir="${DATA_DIR:?}" -debuglogfile="${WALLET_LOG_DIR:?}"/debug.log -conf="${DATA_DIR:?}"/"${WALLET_CONFIG:?}" -debug=tor -proxy="${PROXY:?}" -daemon
fi

# END
