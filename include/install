#!/bin/bash

################################################################################

# colors
B0='\e[34m'   # Blue
B1='\e[94m'   # Blue light
CY='\e[36m'   # Cyan
C1='\e[96m'   # Cyan light
G0='\e[32m'   # Green
G1='\e[92m'   # Green light
GR='\e[90m'   # Grey
N0='\033[0m'  # No color
P0='\e[0;35m' # Purple
P1='\e[1;35m' # Purple light
R0='\e[31m'   # Red
R1='\e[91m'   # Red light
Y0='\e[33m'   # Yellow
Y1='\e[93m'   # Yellow light
BLD='\e[1m'   # Bold\brighter

################################################################################

clear
printf '%b' "${Y0}${BLD}
F   R   E   E   D   O   M   C   O   I   N${B1}

@${N0}@${B1}@${N0}  @${B1}@${N0}@${B1}    @${N0}@${B1}@${N0}@${B1}@${N0}@${B1}    @${N0}@${B1}@${N0}@${B1}@${N0}@${B1}@${N0}    @${B1}@${N0}@${B1}@${N0}@${B1}@${N0}@${B1}@${N0}
${B1}@${N0}@${B1}@${N0}@${B1} @${N0}@${B1}@${N0}   @${B1}@${N0}@${B1}@${N0}@${B1}@${N0}@${B1}@   ${N0}@${B1}@${N0}@${B1}@${N0}@${B1}@${N0}@${B1}@   ${N0}@${B1}@${N0}@${B1}@${N0}@${B1}@${N0}@${B1}@${N0}
${N0}@${B1}@${N0}!${B1}@${N0}!${B1}@${N0}@${B1}@   ${N0}@${B1}@${N0}!  ${B1}@${N0}@${B1}@   ${N0}@${B1}@${N0}!  ${B1}@${N0}@${B1}@   ${N0}@${B1}@${N0}!
!@!!@!@!   !@!  @!@   !@!  @!@   !@!${R1}
@!@ !!@!   @!@  !@!   @!@  !@!   @!!!:!${N0}
!@!  !!!   !@!  !!!   !@!  !!!   !!!!!:${R1}
!!:  !!!   !!:  !!!   !!:  !!!   !!:${N0}
:!:  !:!   :!:  !:!   :!:  !:!   :!:${R1}
::   ::    :::: ::    :::: ::    :: ::::${N0}
::    :     : :  :    :: :  :    : :: ::${R1}
${N0}
Spin up a Freedom node! ${GR}Version 1${N0}
\n"

################################################################################

reset_install() {
  # if missing
  if [[ ! -d /etc/pi-node/include ]] &>/dev/null; then
    # create install directory
    printf '%b' "[${G1}OK${N0}] Mkdir   : Creating install directory as root!\n"
    sudo mkdir /etc/pi-node &>/dev/null
    printf '%b' "[${G1}OK${N0}] Chown   : Updating ownership as $(whoami)!\n"
    sudo chown "$(whoami)":"$(whoami)" /etc/pi-node
    printf '%b' "[${G1}OK${N0}] Install : Installing pi-node dashbord!\n"
    cd || exit && cp pi-node/dash /etc/pi-node
    printf '%b' "[${G1}OK${N0}] Install : Installing directories as $(whoami)!\n"
    cd || exit && cp -rfv pi-node/include /etc/pi-node | column -t
    # create new configuration
    printf '%b' "[${G1}OK${N0}] Echo    : Creating new configuration!\n"
    echo "# pi-node Configuration #
  " >/etc/pi-node/config
  fi
}

################################################################################

# if found
if [[ -f /etc/pi-node/config ]] &>/dev/null; then
  # new configuration
  printf '%b' "[${N0}!!${N0}] Config  : Config found!, reset configuration? y/n "
  read -r -p "" -n 1 -r -s
  echo
  # if yes/no
  if [[ $REPLY =~ ^[Yy]$ ]] &>/dev/null; then
    printf '%b' "[${N0}!!${N0}] Reset   : Deleting old files and directories!\n"
    rm -r /etc/pi-node &>/dev/null
    reset_install
  fi
fi

reset_install

################################################################################

printf '%b' "[${N0}!!${N0}] Check   : Install..\n" && sleep 1
printf '%b' "[${N0}!!${N0}] Github  : Updating pi-node repository!\n"
printf '%b' "[${G1}OK${N0}] Github  : $(cd || exit && cd pi-node && git pull)\n"

################################################################################

VER_FOUND="$(uname -v)"
REL_FOUND="$(uname -r)"
MOD_FOUND="$(grep "Model" /proc/cpuinfo | awk -F: '{ print $2 }' | xargs)"

################################################################################

CPU_FOUND="$(grep "model name" /proc/cpuinfo | head -1 | awk -F: '{ print $2 }' | xargs)"

# if zero
if [[ -z "$CPU_FOUND" ]] &>/dev/null; then
  CPU_FOUND="$(lscpu | grep "Model name" | awk -F: '{ print $2 }' | xargs)"
fi

################################################################################

COR_FOUND="$(egrep -c "bogomips|BogoMIPS" /proc/cpuinfo)"
MEM_FOUND="$(echo "$(echo "$(grep "MemTotal" /proc/meminfo | awk '{ print $2 }')+"$(grep "SwapTotal" /proc/meminfo | awk '{ print $2 }') | bc -l 2>/dev/null)/1024" | bc 2>/dev/null) MB"
HDD_FOUND="$(df -h --total | tail -1 | xargs | tr -d '-')"
HDD_TOTAL="$(echo "$HDD_FOUND" | awk '{ print $2 }')"
HDD_FREE="$(echo "$HDD_FOUND" | awk '{ print $4 }')"

################################################################################
# kernal release version
################################################################################

# if found
if [[ -n "$VER_FOUND" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Version : $VER_FOUND\n"
else
  printf '%b' "[${GR}!!${N0}] System  : Error\n" && exit
fi

# if found
if [[ -n "$REL_FOUND" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Release : $REL_FOUND\n"
else
  printf '%b' "[${GR}!!${N0}] System  : Error\n" && exit
fi

################################################################################
# model
################################################################################

# if found
if [[ -n "$MOD_FOUND" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Model   : $MOD_FOUND\n"
else
  printf '%b' "[${GR}!!${N0}] Model   : ${GR}Not found${N0}\n"
fi

################################################################################
# cpu
################################################################################

# if found
if [[ -n "$CPU_FOUND" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] CPU     : $CPU_FOUND $COR_FOUND Core(s)\n"
else
  printf '%b' "[${GR}!!${N0}] CPU     : Error\n" && exit
fi

################################################################################
# memory
################################################################################

# if found
if [[ -n "$MEM_FOUND" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Memory  : $MEM_FOUND\n"
  # if not enough memory
  if [[ "$(echo "$MEM_FOUND" | awk '{ print $1 }')" -lt "2000" ]] &>/dev/null; then
    printf '%b' "[${GR}!!${N0}] Memory  : Not enough memory!\n" && sleep 1
    printf '%b' "[${G1}OK${N0}] Memory  : Creating 2G Swap..\n"
    # create 2G swap ###########################################################
    sudo fallocate -l 2G /swapfile
    sudo chmod 600 /swapfile
    sudo mkswap /swapfile
    sudo swapon /swapfile
    ############################################################################
    # if swapfile is not already in /etc/fstab, append it
    if ! grep -q "^/swapfile swap swap defaults 0 0" /etc/fstab; then
      printf '%b' "[${G1}OK${N0}] Memory  : Updating fstab..\n"
      echo "/swapfile swap swap defaults 0 0" | sudo tee -a /etc/fstab >/dev/null
    fi
    # backup fstab before modification
    sudo cp /etc/fstab /etc/fstab.bak
    # format `/etc/fstab` properly using `column -t`
    sudo column -t /etc/fstab | sudo tee /etc/fstab >/dev/null
  fi
else
  printf '%b' "[${GR}!!${N0}] Memory  : Error\n" && exit
fi

################################################################################
# hard drive
################################################################################

# if found
if [[ -n "$HDD_FOUND" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Drive   : Total $HDD_TOTAL Free $HDD_FREE\n"
  # if not enough space
  if [[ "$(echo "$HDD_FREE" | egrep "[0-9]+")" -lt "8" ]] &>/dev/null; then
    printf '%b' "[${GR}!!${N0}] Drive   : Not enough space..\n" && exit
  fi
else
  printf '%b' "[${GR}!!${N0}] Drive   : Error\n" && exit
fi

################################################################################
# wallet files
################################################################################

bash /etc/pi-node/include/find

################################################################################
# missing wallet daemon or client
################################################################################

# if no daemon found, if no client found
if [[ "$DAE_FOUND_CTRL" == "null" || "$CLI_FOUND_CTRL" == "null" ]] &>/dev/null; then
  printf '%b' "[${G1}OK${N0}] Dae/Cli : Not Found ${CY}$DAE_FOUND${N0}!\n"
  # linux
  LATEST_RELEASE="$(curl -s https://github.com/FreedomCoin-Project/FreedomCoin-Core/releases/latest | html2text 2>&1 | egrep -A1 "Releases" 2>&1 | tail -1 2>&1 | awk '{ print $2 }')"
  printf '%b' "[${G1}OK${N0}] Release : Checking latest release!\n"
  # change directory
  cd || exit && wget -c https://github.com/FreedomCoin-Project/FreedomCoin-Core/releases/download/"$LATEST_RELEASE"/FreedomCoin-Core-Linux.zip
  printf '%b' "[${G1}OK${N0}] WGet    : Download complete!\n"
  # unzip file
  unzip FreedomCoin-Core-Linux.zip
  printf '%b' "[${G1}OK${N0}] ZIP     : Unzip complete!\n"
  # change directory
  cd FreedomCoin-Core-Linux || exit
  # sudo copy
  sudo mv freedomCoin* /usr/local/bin
  # fix ownership
  sudo chown "$(whoami)":"$(whoami)" /usr/local/bin/freedomcoin*
  printf '%b' "[${G1}OK${N0}] Owner   : Fixing ownership!\n"
else
  printf '%b' "[${G1}OK${N0}] Dae/Cli : Daemon and Client installed!\n"
fi

# END
