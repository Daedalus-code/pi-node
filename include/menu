#!/bin/bash

# By Rainman
# V20220601
# 0.0.7.3

source /home/pi/pitrump.conf

# make sure dialog exist
if ! [ -x "$(command -v dialog)" ] &>/dev/null; then
  sudo apt-get install dialog -y
fi

HEIGHT=8
WIDTH=26
CHOICE_HEIGHT=2
BACKTITLE="Trump-Node"
TITLE="Node Options"
MENU="Choose one of the following options:"

OPTIONS=(1 "Turn off node")

CHOICE=$(dialog --clear \
  --backtitle "$BACKTITLE" \
  --title "$TITLE" \
  --menu "$MENU" \
  $HEIGHT $WIDTH $CHOICE_HEIGHT \
  "${OPTIONS[@]}" \
  2>&1 >/dev/tty)

clear
case $CHOICE in

"1")

  # turn of trumpcoin daemon
  read -r -p "[YN] Turn off daemon, are you sure? y/n " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]] &>/dev/null; then
    if [[ "$(cat "${LOG_DIR:?}"/node_data/peers/failed 2>/dev/null)" -gt "$(cat "${WALLET_DIR:?}"/failed 2>/dev/null)" ]] &>/dev/null; then
      cp "${LOG_DIR:?}"/node_data/peers/failed "${WALLET_DIR:?}"/failed 2>&1
    fi
    read -r -p "[YN] Kill PID?, No for client stop! y/n " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]] &>/dev/null; then
      # hard shutdown, turn off crontab
      sudo service cron stop 2>&1
      kill -9 "$(pidof trumpcoind 2>&1)" && sleep 1
    else # normal shutdown, turn off crontab
      sudo service cron stop 2>&1
      "${WALLET_DIR:?}"/trumpcoin-cli -datadir="${WALLET_DIR:?}" -debuglogfile="${WALLET_LOG_DIR:?}"/debug.log -conf="${WALLET_DIR:?}"/trumpcoin.conf stop && sleep 1
    fi
    read -r -p "[YN] Remove graph databases? y/n " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]] &>/dev/null; then
      rm -r /home/"$(whoami)"/stats/ &>/dev/null
    fi
    read -r -p "[YN] Reboot? y/n " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]] &>/dev/null; then
      sleep 5
      sudo reboot
    else # turn crontab back on if no reboot
      sudo service cron start 2>&1
    fi
  fi
  clear

  ;;

esac

# END
