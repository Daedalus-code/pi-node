#!/bin/bash

# By Rainman
# V20222001
# 0.1.0.8

source /home/pi/pitrump.conf
source /usr/local/bin/include/color

# make sure dialog exist
if ! [ -x "$(command -v dialog)" ] &>/dev/null; then
  sudo apt-get install dialog -y
fi

HEIGHT=10
WIDTH=26
CHOICE_HEIGHT=3
BACKTITLE="Trump-Node"
TITLE="Node Options"
MENU="Choose one of the following options:"

OPTIONS=(1 "Turn off node"
  2 "Import key 🔐 ")

CHOICE=$(dialog --clear \
  --backtitle "$BACKTITLE" \
  --title "$TITLE" \
  --menu "$MENU" \
  $HEIGHT $WIDTH $CHOICE_HEIGHT \
  "${OPTIONS[@]}" \
  2>&1 >/dev/tty)

clear
case $CHOICE in

"1")

  # turn of trumpcoin daemon
  read -r -p "[YN] Turn off daemon, are you sure? y/n " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]] &>/dev/null; then
    if [[ "$(cat "${LOG_DIR:?}"/node_data/peers/failed 2>/dev/null)" -gt "$(cat "${WALLET_DIR:?}"/failed 2>/dev/null)" ]] &>/dev/null; then
      cp "${LOG_DIR:?}"/node_data/peers/failed "${WALLET_DIR:?}"/failed 2>&1
    fi
    read -r -p "[YN] Kill PID?, No for client stop! y/n " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]] &>/dev/null; then
      # hard shutdown, turn off crontab
      sudo service cron stop 2>&1
      kill -9 "$(pidof trumpcoind 2>&1)" &>/dev/null && sleep 1
    else # normal shutdown, turn off crontab
      sudo service cron stop 2>&1
      printf '%b' "[!!] "
      "${WALLET_DIR:?}"/trumpcoin-cli -datadir="${WALLET_DIR:?}" -debuglogfile="${WALLET_LOG_DIR:?}"/debug.log -conf="${WALLET_DIR:?}"/trumpcoin.conf stop && sleep 1
      # wait on node (daemon) to stop
      until ! pidof trumpcoind 2>&1 | wc -w 2>&1 | egrep "1" &>/dev/null; do
        clear
        printf '%b' "[!!] Waiting on trumpcoin (${G1:?}$(pidof trumpcoind 2>&1)${N0:?}) daemon to shutdown..\n"
        sleep 2
      done
    fi
    read -r -p "[YN] Remove graph databases? y/n " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]] &>/dev/null; then
      rm -r /home/"$(whoami)"/stats/ &>/dev/null
    fi
    read -r -p "[YN] Reboot? y/n " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]] &>/dev/null; then
      sleep 5
      sudo reboot
    else # turn crontab back on if no reboot
      sudo service cron start 2>&1
    fi
  fi
  clear

  ;;

"2")

  # Import key
  echo "Adds a private key (as returned by dumpprivkey) to your wallet. Requires a new wallet backup.

Note: This call can take minutes to complete if rescan is true, during that time, other rpc calls
may report that the imported key exists but related transactions are still missing, leading to temporarily incorrect/bogus balances and unspent outputs until rescan completes.
"
  printf '%b' "Enter private key ${G1:?}>${N0:?} "
  read -r IMPORT_KEY
  if [[ -z "$IMPORT_KEY" ]]; then
    # non responsive
    echo "Nothing was typed!"
    sleep 1
    clear
    exit
  fi
  echo "Please wait..! This call can take minutes to complete."
  "${WALLET_DIR:?}"/trumpcoin-cli -datadir="${WALLET_DIR:?}" -debuglogfile="${WALLET_LOG_DIR:?}"/debug.log -conf="${WALLET_DIR:?}"/trumpcoin.conf importprivkey "${IMPORT_KEY:?}"
  clear
  echo
  read -r -p "[Ok] Press Enter to continue" </dev/tty
  echo

  ;;

esac

# END
