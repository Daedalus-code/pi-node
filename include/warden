#!/bin/bash

# By Rainman
# V20211312
# 0.0.4.1

# pitrump configurations
source /home/pi/pitrump.conf
source /usr/local/bin/include/color

# date for logs
LOG_DATE=$(date '+%Y-%d-%mT%TZ' 2>&1)

# screen indicator (is it running)
if ! screen -list 2>&1 |
  grep -q "addnodes" 2>&1; then
  SCREEN_IND="${N0:?}"
else
  SCREEN_IND="${Y1:?}*${N0:?}"
fi

if pidof trumpcoind 2>&1 | wc -l 2>&1 | egrep -q "1" 2>&1; then
  UPTIME=$(ps -p "$(pidof trumpcoind 2>&1)" -o etime 2>&1 | tr -d 'ELAPSED' 2>&1 | xargs 2>&1)
  printf '%b' "${LOG_DATE:?} Stat() Wallet.Warden: ${CY:?}$(pidof trumpcoind 2>&1)${N0:?} [${G1:?}Ok${N0:?}] Uptime $UPTIME $SCREEN_IND${N0:?}\n" >>"${WALLET_LOG_DIR:?}"/debug.log 2>&1
else
  touch "${WALLET_LOG_DIR:?}"/debug.log
  # keep proof-of-work
  POS_COUNT=$(wc -l /home/"$(whoami)"/staking 2>&1 | awk '{ print $1 }' 2>&1)
  printf '%b' "${LOG_DATE:?} Stat() Wallet.Warden: - Stored ${POS_COUNT:?} Proof of work data!${N0:?}\n" >>"${WALLET_LOG_DIR:?}"/debug.log 2>&1
  cat /home/"$(whoami)"/staking >>"${WALLET_LOG_DIR:?}"/debug.log 2>&1
  # remove old files
  rm "$LOG_DIR"/node_data/* &>/dev/null
  truncate -s 0 "${WALLET_LOG_DIR:?}"/debug.log 2>&1
  # make sure tor is installed
  if ! [ -x "$(command -v tor)" ]; then
    sudo apt-get install tor -y
    echo "Setup tor/wallet configurations!"
  fi
  printf '%b' "${LOG_DATE:?} Stat() Wallet.Warden: Starting wallet daemon!${N0:?}\n" >>"${WALLET_LOG_DIR:?}"/debug.log 2>&1
  "$WALLET_DIR"/trumpcoind -datadir="$WALLET_DIR" -debuglogfile="${WALLET_LOG_DIR:?}"/debug.log -conf="$WALLET_DIR"/trumpcoin.conf -proxy=127.0.0.1:9050 -daemon
fi
