#!/bin/bash

# By Rainman
# V20211612
# 0.0.5.3

# pitrump configurations
source /home/pi/pitrump.conf
source /usr/local/bin/include/color

# date for logs
LOG_DATE=$(date '+%Y-%d-%mT%TZ' 2>&1)

# screen indicator (is it running)
if ! screen -list 2>&1 |
  grep -q "addnodes" 2>&1; then
  SCREEN_IND="${GR:?}N${N0:?}"
else
  SCREEN_IND="${Y1:?}*${N0:?}"
fi

if pidof trumpcoind 2>&1 | wc -l 2>&1 | egrep -q "1" 2>&1; then
  # wallet daemon uptime in seconds
  function uptime_cmd() {
    PID="$(pidof trumpcoind)"
    HZ=$(getconf CLK_TCK)
    UPTIME_CMD=$(awk '{print $1}' </proc/uptime)
    STARTTIME=$(awk '{print $22}' </proc/$PID/stat)
    echo $((${UPTIME_CMD%.*} - $STARTTIME / $HZ))
  }
  UPTIME=$(printf '%dh:%dm:%ds\n' $(("$(uptime_cmd)/3600")) $(("$(uptime_cmd)%3600/60")) $(("$(uptime_cmd)%60")))
  printf '%b' "${LOG_DATE:?} Status() Wallet.Warden: ${CY:?}$(pidof trumpcoind 2>&1)${N0:?} [${G1:?}Ok${N0:?}] Uptime ${UPTIME:?} ${SCREEN_IND:?}${N0:?}\n" >>"${WALLET_LOG_DIR:?}"/debug.log 2>&1
else
  touch "${WALLET_LOG_DIR:?}"/debug.log 2>&1
  # keep proof-of-work
  POS_COUNT=$(wc -l /home/"$(whoami)"/staking 2>&1 | awk '{ print $1 }' 2>&1)
  if [[ "$POS_COUNT" -gt "0" ]]; then
    cat /home/"$(whoami)"/staking 2>&1 | awk '!a[$0]++' >>"${WALLET_LOG_DIR:?}"/debug.log 2>&1
    printf '%b' "${LOG_DATE:?} Status() Wallet.Warden: PoS ${G1:?}${POS_COUNT:?}${N0:?} Proof of work data!${N0:?}\n" >>"${WALLET_LOG_DIR:?}"/debug.log 2>&1
  fi
  # remove old files
  rm "$LOG_DIR"/node_data/* &>/dev/null
  truncate -s 0 "${WALLET_LOG_DIR:?}"/debug.log 2>&1
  # make sure tor is installed
  if ! [ -x "$(command -v tor)" ]; then
    sudo apt-get install tor -y
    echo "Setup tor/wallet configurations!"
  fi
  printf '%b' "${LOG_DATE:?} Status() Wallet.Warden: Starting wallet daemon!${N0:?}\n" >>"${WALLET_LOG_DIR:?}"/debug.log 2>&1
  "$WALLET_DIR"/trumpcoind -datadir="$WALLET_DIR" -debuglogfile="${WALLET_LOG_DIR:?}"/debug.log -conf="$WALLET_DIR"/trumpcoin.conf -proxy=127.0.0.1:9050 -daemon
fi

# END
