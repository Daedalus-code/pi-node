#!/bin/bash

# By Rainman
# V20212012
# 0.0.6.1

# pitrump configurations
source /home/pi/pitrump.conf
source /usr/local/bin/include/color

# date for logs
LOG_DATE=$(date '+%Y-%d-%mT%TZ' 2>&1)

# screen indicator (is it running)
if ! screen -list 2>&1 |
  grep -q "addnodes" 2>&1; then
  SCREEN_IND="${GR:?}N${N0:?}"
else
  SCREEN_IND="${Y1:?}*${N0:?}"
fi

# wallet daemon uptime in seconds
function uptime_daemon() {
  PID="$(pidof trumpcoind 2>&1)"
  HZ=$(getconf CLK_TCK 2>&1)
  UPTIME_CMD=$(awk '{print $1}' </proc/uptime)
  STARTTIME=$(awk '{print $22}' </proc/"$PID"/stat)
  echo $(("${UPTIME_CMD%.*}" - "$STARTTIME" / "$HZ"))
}

if [[ "$(uptime_daemon)" -gt "1" ]]; then
  # error: couldn't connect to server
  if grep -o "error: couldn't connect to server" "$LOG_DIR"/node_data/tmp/getinfo; then
    # error with server (daemon), stopping
    printf '%b' "${R1:?}${LOG_DATE:?} Status() Wallet.Warden: PID() $(pidof trumpcoind 2>&1) Couldn't connect to server! Stopping daemon now!${N0:?}${N0:?}\n" >>"${WALLET_LOG_DIR:?}"/debug.log 2>&1
    "$WALLET_DIR"/trumpcoin-cli -datadir=./ stop
    printf '%b' "${N0:?}${LOG_DATE:?} Status() Wallet.Warden: ${GR:?}::${N0:?} [${R1:?}XX${N0:?}] ${GR:?}::${N0:?} Rebooting system now!${N0:?}${N0:?}\n" >>"${WALLET_LOG_DIR:?}"/debug.log 2>&1
    sudo reboot 2>&1
  fi
fi

# daemon uptime greater then n
if [[ "$(uptime_daemon)" -gt "1" ]]; then
  if pgrep -x trumpcoind &>/dev/null; then
    UPTIME=$(printf '%dh:%dm:%ds\n' $(("$(uptime_daemon)/3600")) $(("$(uptime_daemon)%3600/60")) $(("$(uptime_daemon)%60")))
    printf '%b' "${LOG_DATE:?} Status() Wallet.Warden: PID() ${CY:?}$(pidof trumpcoind 2>&1)${N0:?} ${GR:?}::${N0:?} [${G1:?}Ok${N0:?}] ${GR:?}::${N0:?} Daemon Uptime ${UPTIME:?} ${SCREEN_IND:?}${N0:?}\n" >>"${WALLET_LOG_DIR:?}"/debug.log 2>&1
  else
    # restore personal addnodes list from wallet directory
    cp "${WALLET_LOG_DIR:?}"/addnodes /home/"$(whoami)"/addnodes 2>&1
    WALLET_ADDNODES=$(cat "${WALLET_LOG_DIR:?}"/addnodes 2>/dev/null | tail -1 2>&1)
    printf '%b' "${LOG_DATE:?} Status() Wallet.Warden: Restoring personal addnodes! (${GR:?}${WALLET_ADDNODES:?}${N0:?})${N0:?}\n" >>"${WALLET_LOG_DIR:?}"/debug.log 2>&1
    touch "${WALLET_LOG_DIR:?}"/debug.log 2>&1
    # remove old files
    rm -R "$LOG_DIR"/node_data/* &>/dev/null
    truncate -s 0 "${WALLET_LOG_DIR:?}"/debug.log 2>&1
    printf '%b' "${LOG_DATE:?} Status() Wallet.Warden: PID() ? Starting wallet daemon!${N0:?}\n" >>"${WALLET_LOG_DIR:?}"/debug.log 2>&1
    "$WALLET_DIR"/trumpcoind -datadir="$WALLET_DIR" -debuglogfile="${WALLET_LOG_DIR:?}"/debug.log -conf="$WALLET_DIR"/trumpcoin.conf -proxy=127.0.0.1:9050 -daemon
  fi
fi

# END
